var server=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),arduino_check_connect_sec=300,arduino_check_broken_connect_sec=60,branch=[];function branch_on(e,t){$.ajax({url:"/activate_branch",type:"get",data:{id:e,time_min:t},success:function(t){console.log("Line "+branch[e].name+" should be actived now"),update_branches(t)},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,0),set_status_error()}})}function branch_off(e){$.ajax({url:"/deactivate_branch",type:"get",data:{id:e},success:function(t){console.log("Line "+branch[e].name+" should be deactivated now"),update_branches(t)},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,1),set_status_error()}})}function update_branches_request(){$.ajax({url:server+"/arduino_small_house_status",success:function(e){update_branches(e)},error:function(){console.error("Branches statuses are out-of-date"),set_status_error()}})}function update_branches(e){arr=e.branches;for(var t=0;t<=arr.length;t++)toogle_card(t,arr[t])}function toogle_card(e,t){null!=t&&(branch_state=t.status,1==branch_state?($("#card-"+e).addClass("card-irrigate-active"),$("#btn-start-"+e).hide().addClass("hidden"),$("#btn-start-with-options-"+e).hide().addClass("hidden"),$("#btn-stop-"+e).css("display","inline-block").removeClass("hidden")):($("#card-"+e).removeClass("card-irrigate-active"),$("#btn-stop-"+e).hide().addClass("hidden"),$("#btn-start-"+e).css("display","inline-block").removeClass("hidden"),$("#btn-start-with-options-"+e).css("display","inline-block").removeClass("hidden")))}$(document).ready(function(){$.ajax({url:"/power_outlets_settings",success:function(e){list=e.list;for(j in list)item=list[j],branch[item.id]={name:item.name,default_time:parseInt(item.default_time)}}}),function e(){$.ajax({url:"/arduino_small_house_status",beforeSend:function(e,t){$("#power_outle_modal").hasClass("in")&&e.abort()},success:function(t){console.log("connected to raspberry"),update_branches(t),set_status_ok(),setTimeout(e,1e3*arduino_check_connect_sec)},error:function(){console.error("Can't connect to raspberry"),set_status_error(),setTimeout(e,1e3*arduino_check_broken_connect_sec)}})}();var e=io.connect(server,{"sync disconnect on unload":!0});e.on("connect",function(){console.log("connected to websocket")}),e.on("power_outlet_status",function(e){console.log("Message received. New brach status: "+e.data),update_branches(JSON.parse(e.data))}),$("#power_outlet_modal").on("hidden.bs.modal",function(){update_branches_request()}),$(".btn-open-modal").click(function(){index=$(this).data("id"),name=branch[index].name,time=branch[index].default_time,$("#power_outlet_minutes").val(time),$("#power_outlet_modal").data("id",index),$(".modal-title").html(name),$("#power_outlet_modal").modal("show")}),$(".start-power_outlet").click(function(){index=$("#power_outlet_modal").data("id"),time=parseInt($("#power_outlet_minutes").val()),0==time||isNaN(time)?$("#power_outlet_minutes_group").addClass("has-danger"):$("#power_outlet_minutes_group").removeClass("has-danger"),$("#power_outlet_minutes_group").hasClass("has-danger")?console.log("Fill in form correctly"):(console.log(branch[index].name+" will be activated on "+time+" minutes "),branch_on(index,time),$("#power_outlet_modal").modal("hide"))}),$(".btn-start").click(function(){index=$(this).data("id"),console.log(branch[index].name+" will be activated on "+branch[index].default_time+" minutes "),branch_on(index,branch[index].default_time)}),$(".stop-power_outlet").click(function(){index=$(this).data("id"),console.log(branch[index].name+" will be deactivated now"),branch_off(index)})});var class_ok={msg:" Система активна",class:"fa fa-refresh"},class_spin={msg:" Перевірка статусу системи...",class:"fa fa-refresh fa-spin"},class_err={msg:" В системі помилка",class:"status-error"};function set_status_error(){$(".card-power").addClass(class_err.class),$(".btn-open-modal").addClass("disabled"),$(".btn-start").addClass("disabled"),$(".stop-power_outlet").addClass("disabled"),$(".status-span").css("display","inline-block")}function set_status_ok(){$(".card-power").removeClass(class_err.class),$(".btn-open-modal").removeClass("disabled"),$(".btn-start").removeClass("disabled"),$(".stop-power_outlet").removeClass("disabled"),$(".status-span").hide(),$(".btn-open-modal").show()}