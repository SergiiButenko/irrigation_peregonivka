CREATE TABLE current_lines_state (
    id INTEGER PRIMARY KEY,
    line_id integer NOT NULL,
    state_id integer NOT NULL
);

CREATE TABLE state_of_line (
    id INTEGER PRIMARY KEY,
    short_name text NOT NULL,
    full_name text NOT NULL
);

CREATE TABLE rain (
    id INTEGER PRIMARY KEY,
    datetime time without time zone NOT NULL DEFAULT (datetime('now','localtime')),
    volume REAL NOT NULL
);

CREATE TABLE moisture (
    id INTEGER PRIMARY KEY,
    datetime time without time zone NOT NULL DEFAULT (datetime('now','localtime')),
    line_id integer NOT NULL,
    value REAL NOT NULL DEFAULT 0
);

CREATE TABLE life (
    id INTEGER PRIMARY KEY,
    line_id integer NOT NULL,
    rule_id integer NOT NULL,
    state integer DEFAULT 0 NOT NULL,
    date date NOT NULL,
    timer timestamp without time zone NOT NULL,
    active integer DEFAULT 1 NOT NULL, 
    interval_id text, 
    time integer default 0 NOT NULL,
    FOREIGN KEY(line_id) REFERENCES lines(number),
    FOREIGN KEY(state) REFERENCES state_of_rule(id),
    FOREIGN KEY(rule_id) REFERENCES type_of_rule(id)
);


CREATE TABLE ongoing_rules (
    id INTEGER PRIMARY KEY,
    line_id integer NOT NULL,
    time integer NOT NULL,
    intervals integer NOT NULL,
    time_wait integer NOT NULL,
    repeat_value integer NOT NULL,
    dow text,
    date_start timestamp without time zone NOT NULL,
    time_start timestamp without time zone NOT NULL,
    end_value integer NOT NULL,
    end_date timestamp without time zone,
    end_repeat_quantity integer,
    active integer NOT NULL DEFAULT 0, 
    FOREIGN KEY(line_id) REFERENCES lines(number)
);

CREATE TABLE line_groups (
id INTEGER PRIMARY KEY,
name text NOT NULL, 
s0 integer, 
s1 integer, 
s2 integer, 
s3 integer, 
en integer, 
multiplex integer default 1);

CREATE TABLE lines (
    id INTEGER PRIMARY KEY,
    number integer NOT NULL,
    name text NOT NULL,
    time integer NOT NULL DEFAULT 10,
    intervals integer NOT NULL DEFAULT 2,
    time_wait integer NOT NULL DEFAULT 15, 
    start_time time without time zone NOT NULL DEFAULT '2017-06-29 18:34:00', 
    line_type text NOT NULL default 'irrigation', 
    base_url text, 
    pump_enabled integer NOT NULL DEFAULT 1,
    relay_num integer, 
    pin integer, 
    group_id integer not null default 0, 
    is_pump integer not null default 0, 
    is_except integer not null default 0, 
    pump_pin integer,
    FOREIGN KEY(group_id) REFERENCES line_groups(id));


CREATE TABLE state_of_rule (
    id INTEGER PRIMARY KEY,
    short_name text NOT NULL,
    full_name text NOT NULL
);

CREATE TABLE type_of_rule (
    id INTEGER PRIMARY KEY,
    name text NOT NULL
);

CREATE TABLE ongoing_rules (
    id INTEGER PRIMARY KEY,
    line_id integer NOT NULL,
    time integer NOT NULL,
    intervals integer NOT NULL,
    time_wait integer NOT NULL,
    repeat_value integer NOT NULL,
    date_time_start timestamp without time zone NOT NULL,
    end_date timestamp without time zone,
    active integer NOT NULL DEFAULT 0, 
    rule_id text, 
    FOREIGN KEY(line_id) REFERENCES lines(number)
);

INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (15, 'Огурцы', 10, 2, 15);
INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (13, 'Клубника клумба', 10, 2, 15);
INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (16, 'Клубника беседка', 10, 2, 15);
INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (12, 'Помидоры', 10, 2, 15);
INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (14, 'Малина', 10, 2, 15);
INSERT INTO lines (number, name, time, intervals, time_wait) VALUES (17, 'Насос', 10, 2, 15);

INSERT INTO state_of_line (short_name, full_name) VALUES ('Active','Рабочая');
INSERT INTO state_of_line (short_name, full_name) VALUES ('Deactive','Не рабочая');
INSERT INTO state_of_line (short_name, full_name) VALUES ('Repair','Ремонт');

INSERT INTO state_of_rule (short_name, full_name) VALUES ('Pending', 'Запланировано');
INSERT INTO state_of_rule (short_name, full_name) VALUES ('Done', 'Выполнено');
INSERT INTO state_of_rule (short_name, full_name) VALUES ('Failed', 'Не выполнено');
INSERT INTO state_of_rule (short_name, full_name) VALUES ('Canceled', 'Отменено');
INSERT INTO state_of_rule (short_name, full_name) VALUES ('Canceled_by_rain', 'Отменено из-за дождя');
INSERT INTO state_of_rule (short_name, full_name) VALUES ('Canceled_by_humidity', 'Отменено из-за влажности');

INSERT INTO type_of_rule (name) VALUES ('Начать полив');
INSERT INTO type_of_rule (name) VALUES ('Остановить полив');





insert into line_groups (id, name, s0, s1, s2, s3, en, multiplex) VALUES (1, 'Насос', null, null, null, null, null, 0);
insert into line_groups (id, name, s0, s1, s2, s3, en, multiplex) VALUES (2, 'Полив з бочки', 16, 17, 18, 19, 20, 1);
insert into line_groups (id, name, s0, s1, s2, s3, en, multiplex) VALUES (3, 'Полив з системи', null, null, null, null, null, 0);
insert into line_groups (id, name, s0, s1, s2, s3, en, multiplex) VALUES (4, 'Ліхтар', null, null, null, null, null, 0);
insert into line_groups (id, name, s0, s1, s2, s3, en, multiplex) VALUES (5, 'Верхня бочка', null, null, null, null, null, 0);


insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (1, 1, 'Насос', 10, 2, 15, '2017-06-29 18:34:00', 'irrigation', '', 0, null, 12, 1, 1, 1, null);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (2, 2, 'Огірки', 10, 2, 15, '2017-06-29 19:00:00', 'irrigation', '', 1, 1, null, 2, 0, 0, 12);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (3, 3, 'Полуниця клумба', 10, 2, 15, '2017-06-29 20:00:00', 'irrigation', '', 1, 2, null, 2, 0, 0, 12);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (4, 4, 'Полуниця альтанка', 10, 2, 15, '2017-06-29 21:00:00', 'irrigation', '', 1, 3, null, 2, 0, 0, 12);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (5, 5, 'Томати', 10, 2, 15, '2017-06-29 06:00:00', 'irrigation', '', 1, 4, null, 2, 0, 0, 12);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (6, 6, 'Малина', 10, 2, 15, '2017-06-29 22:00:00', 'irrigation', '', 1, 5, null, 2, 0, 0, 12);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (7, 7, 'Ліхтар', 300, 1, 1, '2017-06-29 18:34:00', 'lighting', '', 0, null, 13, 4, 0, 1, null);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (8, 8, 'Кіпариси', 10, 2, 15, '2017-06-29 19:30:00', 'irrigation', null, 0, null, 14, 3, 0, 1, null);

insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (9, 9, 'Смородина', 10, 2, 15, '2017-06-29 18:30:00', 'irrigation', null, 0, null, 15, 3, 0, 1, null);


insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (13, 13, 'Квіти', 10, 2, 15, '2017-06-29 07:00:00', 'irrigation', null, 1, 5, null, 2, 0, 0, 16, null);


insert into lines(id, number, name, time, intervals, time_wait, start_time, line_type, base_url, pump_enabled, relay_num, pin, group_id, is_pump, is_except, pump_pin) VALUES (14, 14, 'Верхня бочка', 600, 1, 1, '2017-06-29 00:00:00', 'tank', null, 0, null, 26, 5, 0, 1, null, null);
