var arduino_check_connect_sec=300,arduino_check_broken_connect_sec=60,branch=[];$(document).ready(function(){$(".add_rule").on("click",function(){$.ajax({url:"/branch_settings",success:function(t){list=t.list,$("#branch_select_plann_modal").find("option").remove();for(j in list)item=list[j],branch[item.id]={name:item.name,default_time:parseInt(item.default_time),default_interval:parseInt(item.default_interval),default_time_wait:parseInt(item.default_time_wait),start_time:new Date(item.start_time)},$("#branch_select_plann_modal").append("<option value="+item.id+">"+item.name+"</option>");var e=$("#plann_modal"),a=convert_date(new Date);$(e).find($(".irrigation_date_plann_modal")).val(a),set_branch_defaults(parseInt($("#branch_select_plann_modal option:selected").val()),e),$("#plann_modal").modal("show")}})}),$("#branch_select_plann_modal").off().on("change",function(t){modal=$("#plann_modal"),set_branch_defaults(parseInt($(this).val()),modal)}),$("#irrigation_intervals_plann_modal").on("input",function(t){modal=$("#plann_modal");var e=parseInt($(this).val());e<=1||isNaN(e)?$(modal).find("#irrigation_time_wait_group").hide():$(modal).find("#irrigation_time_wait_group").css("display","inline-block")}),$(".plan").click(function(){var t={rules:[]},e=$(this).closest("#plann_modal"),a=$(e).find("#branch_select_plann_modal option:selected").val(),n=$(e).find("#branch_select_plann_modal option:selected").text(),i=$(e).find("#irrigation_minutes_plann_modal").val(),r=$(e).find("#irrigation_intervals_plann_modal").val(),s=$(e).find("#irrigation_time_wait_plann_modal").val(),l=$(e).find(".irrigation_date_plann_modal").val(),o=$(e).find(".irrigation_time_plann_modal").val();t.rules.push({line_id:a,line_name:n,time:i,intervals:r,time_wait:s,date_start:l,time_start:o,end_date:l,repeat_value:4}),$.ajax({url:"/add_ongoing_rule",type:"post",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:function(t,e){set_status_spinner()},success:function(){set_status_ok(),$("#plann_modal").modal("hide")},error:function(){alert("error"),set_status_ok()}})}),function t(){$.ajax({url:"/weather",success:function(e){$("#temp").text(e.temperature),$("#hum").text(e.humidity),$("#rain").text(e.rain),1==e.rain_status?$("#irrigation_status").text("Автоматичний полив дозволений"):$("#irrigation_status").text("Автоматичний полив заборонений"),setTimeout(t,18e5)}})}();$.each(["drawer-f-l","drawer-f-r","drawer-f-t","drawer-f-b"],function(t,e){$("#"+e).click(function(){setDrawerPosition("bmd-"+e)})}),$("#drawer-visibility").click(function(){var t=$(".bmd-layout-container"),e=$(this),a=e.find(".material-icons");"visibility"==a.text()?(t.addClass("bmd-drawer-out"),a.text("visibility_off"),e.attr("title","Drawer allow responsive opening")):(t.removeClass("bmd-drawer-out"),a.text("visibility"),e.attr("title","Drawer force closed"))})});var class_ok={msg:" Система активна",class:"fa fa-refresh"},class_spin={msg:" Перевірка статусу системи...",class:"fa fa-refresh fa-spin"},class_err={msg:" В системі помилка",class:"status-error"};function set_status_error(){$(".card-irrigation").addClass(class_err.class),$(".card-lighting").addClass(class_err.class),$(".btn").addClass("disabled"),$(".status-span").css("display","inline-block")}function set_status_ok(){$(".btn").removeClass("disabled"),$(".status-span").hide()}function set_status_spinner(){$(".btn").addClass("disabled")}function clearDrawerClasses(t){$.each(["bmd-drawer-f-l","bmd-drawer-f-r","bmd-drawer-f-t","bmd-drawer-f-b"],function(e,a){t.removeClass(a)})}function setDrawerPosition(t){var e=$(".bmd-layout-container");clearDrawerClasses(e),e.addClass(t)}function convert_date_to_time(t){return t instanceof Date==0&&(t=new Date(t)),("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)}function convert_date_to_time_utc(t){return t instanceof Date==0&&(t=new Date(t)),("0"+(t=convertDateToUTC(t)).getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)}function convert_date(t){t instanceof Date==0&&(t=new Date(t));var e=("0"+t.getDate()).slice(-2),a=("0"+(t.getMonth()+1)).slice(-2);return t.getFullYear()+"-"+a+"-"+e}function convert_date_to_local_date(t){var e=new Date;e.setDate(e.getDate()+parseInt(t));var a=("0"+e.getDate()).slice(-2),n=("0"+(e.getMonth()+1)).slice(-2);return e.getFullYear()+"-"+n+"-"+a}function get_parameter_by_name(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}function daydiff(t,e){return date1=new Date(t.getFullYear(),t.getMonth(),t.getDate()),date2=new Date(e.getFullYear(),e.getMonth(),e.getDate()),Math.ceil((date2-date1)/864e5)}function convertDateToUTC(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())}function toogle_time_wait(t,e){var a=parseInt(t);void 0==e?a<=1||isNaN(a)?$("#irrigation_time_wait_group").hide():$("#irrigation_time_wait_group").show():a<=1||isNaN(a)?$(e).find("#irrigation_time_wait_group").hide():$(e).find("#irrigation_time_wait_group").show()}function set_branch_defaults(t,e){branch[t].name;var a=branch[t].default_time,n=branch[t].default_interval,i=branch[t].default_time_wait,r=branch[t].start_time;void 0!=e?($(e).find("#irrigation_minutes_plann_modal").val(a),$(e).find("#irrigation_intervals_plann_modal").val(n),$(e).find("#irrigation_time_wait_plann_modal").val(i),$(e).find(".irrigation_time_plann_modal").val(convert_date_to_time(r))):($("#irrigation_minutes").val(a),$("#irrigation_intervals").val(n),$("#irrigation_time_wait").val(i),$(".irrigation_time").val(convert_date_to_time(r))),toogle_time_wait(n,e)}