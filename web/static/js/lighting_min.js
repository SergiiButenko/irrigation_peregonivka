var server=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),arduino_check_connect_sec=300,arduino_check_broken_connect_sec=60,branch=[];function branch_on(e,n){$.ajax({url:"/activate_branch",type:"get",data:{id:e,time_min:n,mode:"single"},success:function(n){console.log("Line "+branch[e].name+" should be actived now"),update_branches(n)},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,0),set_status_error()}})}function branch_off(e){$.ajax({url:"/deactivate_branch",type:"get",data:{id:e,mode:"manually"},success:function(n){console.log("Line "+branch[e].name+" should be deactivated now"),update_branches(n)},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,1),set_status_error()}})}function update_branches_request(){$.ajax({url:"/irrigation_lighting_status",success:function(e){update_branches(e)},error:function(){console.error("Branches statuses are out-of-date"),set_status_error()}})}function update_branches(e){arr=e.branches;for(var n=0;n<=arr.length;n++)toogle_card(n,arr[n])}function toogle_card(e,n){if(null!=n){branch_state=n.status,1==branch_state?($("#card-"+e).addClass("card-irrigate-active"),$("#btn-start-"+e).hide().addClass("hidden"),$("#btn-start-with-options-"+e).hide().addClass("hidden"),$("#btn-stop-"+e).css("display","inline-block").removeClass("hidden")):($("#card-"+e).removeClass("card-irrigate-active"),$("#btn-stop-"+e).hide().addClass("hidden"),$("#btn-start-"+e).css("display","inline-block").removeClass("hidden"),$("#btn-start-with-options-"+e).css("display","inline-block").removeClass("hidden"));var t={weekday:"long",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"UTC"};n.next_rule&&1==n.next_rule.rule_id?(next_rule=n.next_rule.timer,next_rule=new Date(next_rule).toLocaleTimeString("uk-UA",t),$("#next-"+e).css("display","inline-block").removeClass("hidden"),$("#next-"+e).html("</br>Наступний запуск: "+next_rule),$("#btn-cancel-"+e).data("id",n.next_rule.id),$("#btn-cancel-"+e).css("display","inline-block").removeClass("hidden")):n.next_rule&&2==n.next_rule.rule_id?(next_rule=n.next_rule.timer,next_rule=new Date(next_rule).toLocaleTimeString("uk-UA",t),$("#next-"+e).css("display","inline-block").removeClass("hidden"),$("#next-"+e).html("</br>Освітлення вимкнеться: "+next_rule),$("#btn-cancel-"+e).hide().addClass("hidden")):($("#next-"+e).html("</br>Наступний запуск: немає запису"),$("#next-"+e).hide().addClass("hidden"),$("#btn-cancel-"+e).hide().addClass("hidden"))}}$(document).ready(function(){$.ajax({url:"/lighting_settings",success:function(e){list=e.list;for(j in list)item=list[j],branch[item.id]={name:item.name,default_time:parseInt(item.default_time)}}}),function e(){$.ajax({url:"/irrigation_lighting_status",beforeSend:function(e,n){set_status_spinner(),$("#lighting_modal").hasClass("in")&&e.abort()},success:function(n){console.log("connected to raspberry"),update_branches(n),set_status_ok(),setTimeout(e,1e3*arduino_check_connect_sec)},error:function(){console.error("Can't connect to raspberry"),set_status_error(),setTimeout(e,1e3*arduino_check_broken_connect_sec)}})}();var e=io.connect(server,{"sync disconnect on unload":!0});e.on("connect",function(){console.log("connected to websocket")}),e.on("lighting_status",function(e){console.log("Message received. New brach status: "+e.data),update_branches(JSON.parse(e.data))}),$("#lighting_modal").on("hidden.bs.modal",function(){update_branches_request()}),$(".btn-open-modal").click(function(){index=$(this).data("id"),name=branch[index].name,time=branch[index].default_time,$("#lighting_minutes").val(time),$("#lighting_modal").data("id",index),$(".modal-title").html(name),$("#lighting_modal").modal("show")}),$(".start-lighting").click(function(){index=$("#lighting_modal").data("id"),time=parseInt($("#lighting_minutes").val()),0==time||isNaN(time)?$("#lighting_minutes_group").addClass("has-danger"):$("#lighting_minutes_group").removeClass("has-danger"),$("#lighting_minutes_group").hasClass("has-danger")?console.log("Fill in form correctly"):(console.log(branch[index].name+" will be activated on "+time+" minutes "),branch_on(index,time),$("#lighting_modal").modal("hide"))}),$(".btn-start").click(function(){index=$(this).data("id"),console.log(branch[index].name+" will be activated on "+branch[index].default_time+" minutes "),branch_on(index,branch[index].default_time)}),$(".stop-lighting").click(function(){index=$(this).data("id"),console.log(branch[index].name+" will be deactivated now"),branch_off(index)})});