var server=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),arduino_check_connect_sec=300,arduino_check_broken_connect_sec=60,branch=[];function branch_on(e,t,a,i){mode=1==a?"single":"interval",$.ajax({url:"/activate_branch",type:"get",data:{mode:mode,id:e,time_min:t,quantity:a,time_wait:i},beforeSend:function(e,t){set_status_spinner()},success:function(t){console.log("Line "+branch[e].name+" should be active now"),update_branches(t),set_status_ok()},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,0),set_status_error()}})}function branch_off(e){$.ajax({url:"/deactivate_branch",type:"get",data:{id:e,mode:"manually"},beforeSend:function(e,t){set_status_spinner()},success:function(t){console.log("Line "+branch[e].name+" should be deactivated now"),update_branches(t),set_status_ok()},error:function(){console.error("Can't update "+branch[e].name),toogle_card(e,1),set_status_error()}})}function update_branches_request(){$.ajax({url:"/irrigation_lighting_status",success:function(e){update_branches(e)},error:function(){console.error("Branches statuses are out-of-date"),set_status_error()}})}function update_branches(e){arr=e.branches;for(var t=0;t<=arr.length;t++)toogle_card(t,arr[t])}function toogle_card(e,t){if(null!=t){branch_state=t.status,1==branch_state?($("#card-"+e).addClass("card-irrigate-active"),$("#btn-start-"+e).hide().addClass("hidden"),$("#btn-stop-"+e).css("display","inline-block").removeClass("hidden")):($("#card-"+e).removeClass("card-irrigate-active"),$("#btn-stop-"+e).hide().addClass("hidden"),$("#btn-start-"+e).css("display","inline-block").removeClass("hidden"));var a={weekday:"long",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"},i={hour:"2-digit",minute:"2-digit"},n=new Date;t.last_rule?(last_rule=convertDateToUTC(new Date(t.last_rule.timer)),0==daydiff(n,last_rule)?last_rule="сьогодні, о "+last_rule.toLocaleTimeString("uk-UA",i):-1==daydiff(n,last_rule)?last_rule="вчора, о "+last_rule.toLocaleTimeString("uk-UA",i):last_rule=last_rule.toLocaleTimeString("uk-UA",a)):last_rule="немає запису",$("#last-"+e).text("Останній полив: "+last_rule),t.next_rule&&1==t.next_rule.rule_id?(next_rule=convertDateToUTC(new Date(t.next_rule.timer)),0==daydiff(n,next_rule)?next_rule="сьогодні, о "+next_rule.toLocaleTimeString("uk-UA",i):1==daydiff(n,next_rule)?next_rule="завтра, о "+next_rule.toLocaleTimeString("uk-UA",i):2==daydiff(n,next_rule)?next_rule="післязавтра, о "+next_rule.toLocaleTimeString("uk-UA",i):next_rule=next_rule.toLocaleTimeString("uk-UA",a),$("#next-"+e).css("display","inline-block").removeClass("hidden"),$("#next-"+e).html("</br>Наступний полив: "+next_rule),$("#btn-cancel-"+e).data("id",t.next_rule.id),$("#btn-cancel-"+e).css("display","inline-block").removeClass("hidden")):t.next_rule&&2==t.next_rule.rule_id?(next_rule=convertDateToUTC(new Date(t.next_rule.timer)),0==daydiff(n,next_rule)?next_rule="сьогодні, о "+next_rule.toLocaleTimeString("uk-UA",i):1==daydiff(n,next_rule)?next_rule="завтра, о "+next_rule.toLocaleTimeString("uk-UA",i):2==daydiff(n,next_rule)?next_rule="післязавтра, о "+next_rule.toLocaleTimeString("uk-UA",i):next_rule=next_rule.toLocaleTimeString("uk-UA",a),$("#next-"+e).css("display","inline-block").removeClass("hidden"),$("#next-"+e).html("</br>Полив зупиниться: "+next_rule),$("#btn-cancel-"+e).hide().addClass("hidden")):($("#next-"+e).html("</br>Наступний полив: немає запису"),$("#next-"+e).hide().addClass("hidden"),$("#btn-cancel-"+e).hide().addClass("hidden"))}}$(document).ready(function(){var e=io.connect(server,{"sync disconnect on unload":!0});e.on("connect",function(){console.log("connected to websocket")}),e.on("branch_status",function(e){console.log("Message received. New brach status: "+e.data),update_branches(JSON.parse(e.data))}),$.ajax({url:"/branch_settings",success:function(e){list=e.list;for(j in list)item=list[j],branch[item.id]={name:item.name,default_time:parseInt(item.default_time),default_interval:parseInt(item.default_interval),default_time_wait:parseInt(item.default_time_wait),start_time:new Date(item.start_time)}}}),function e(){$.ajax({url:"/irrigation_lighting_status",beforeSend:function(e,t){set_status_spinner(),$("#irrigate_modal").hasClass("in")&&e.abort()},success:function(t){console.log("connected to arduino"),update_branches(t),set_status_ok(),setTimeout(e,1e3*arduino_check_connect_sec)},error:function(){console.error("Can't connect to arduino"),set_status_error(),setTimeout(e,1e3*arduino_check_broken_connect_sec)}})}(),$("#irrigation_intervals").on("input",function(e){var t=parseInt($(this).val());t<=1||isNaN(t)?$("#irrigation_time_wait_group").hide():$("#irrigation_time_wait_group").css("display","inline-block")}),$(".btn-open-modal").click(function(){index=$(this).data("id"),name=branch[index].name,time=branch[index].default_time,interval=branch[index].default_interval,time_wait=branch[index].default_time_wait,$("#irrigation_minutes").val(time),$("#irrigation_intervals").val(interval),$("#irrigation_time_wait").val(time_wait),$("#irrigate_modal").data("id",index),interval<=1?$("#irrigation_time_wait_group").hide():$("#irrigation_time_wait_group").css("display","inline-block"),$(".modal-title").html(name),$("#irrigate_modal").modal("show")}),$(".start-irrigation").click(function(){index=$("#irrigate_modal").data("id"),time=parseInt($("#irrigation_minutes").val()),0==time||isNaN(time)?$("#irrigation_minutes_group").addClass("has-danger"):$("#irrigation_minutes_group").removeClass("has-danger"),interval_quantity=parseInt($("#irrigation_intervals").val()),0==interval_quantity||isNaN(interval_quantity)?$("#irrigation_intervals_group").addClass("has-danger"):$("#irrigation_intervals_group").removeClass("has-danger"),time_wait=parseInt($("#irrigation_time_wait").val()),0==time_wait||isNaN(time_wait)?$("#irrigation_time_wait_group").addClass("has-danger"):$("#irrigation_time_wait_group").removeClass("has-danger"),$("#irrigation_minutes_group").hasClass("has-danger")||$("#irrigation_intervals_group").hasClass("has-danger")||$("#irrigation_time_wait_group").hasClass("has-danger")?console.log("Fill in form correctly"):(console.log(branch[index].name+" will be activated on "+time+" minutes, "+interval_quantity+" times with "+time_wait+" period"),branch_on(index,time,interval_quantity,time_wait),$("#irrigate_modal").modal("hide"))}),$(".stop-irrigation").click(function(){index=$(this).data("id"),console.log(branch[index].name+" will be deactivated now"),branch_off(index)}),$(".cancel-irrigation").click(function(){index=$(this).data("id"),console.log(index+" irrigation schedule will be canceled"),$.ajax({url:server+"/cancel_rule",type:"get",data:{id:index},beforeSend:function(e,t){set_status_spinner()},success:function(e){set_status_ok()},error:function(){set_status_ok()}})})});